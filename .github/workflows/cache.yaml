name: build and push cache to attic

on:
  push:
  workflow_dispatch:

jobs:
  cache:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: connect to attic
        run: |
          attic login --set-default atticd http://localhost:8080/ ${{ secrets.ATTIC_TOKEN }}
          attic use local
      - name: build
        run: |
          nix-fast-build \
          --flake .#build \
          --option access-tokens github.com=${{ secrets.PAT }} \
          --no-nom \
          --systems "x86_64-linux" \
          --skip-cached \
          --attic-cache local \
          --eval-max-memory-size 4096 \
          --eval-workers 3
