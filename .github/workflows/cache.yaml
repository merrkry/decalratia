name: build and push cache to attic

on:
  push:
  workflow_dispatch:

jobs:
  cache:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: connect to attic
        run: |
          attic login --set-default atticd http://localhost:20002/ ${{ secrets.ATTIC_TOKEN }}
      # Has weired bug recently, with --skip-cached the whole building process is skipped,
      # without it an error will occur when trying to upload result.
      # - name: build
      #   run: |
      #     nix-fast-build \
      #       --flake ".#build.$(nix eval --raw --impure --expr 'builtins.currentSystem')" \
      #       --option access-tokens github.com=${{ secrets.PAT }} \
      #       --no-nom \
      #       --attic-cache selfhosted \
      #       --debug \
      #       --eval-max-memory-size 4096 \
      #       --eval-workers 4
      - name: build configurations and push to attic
        run: |
          arch="$(nix eval --raw --impure --expr 'builtins.currentSystem')"
          hosts="$(nix eval --raw .#build.${arch} --apply 'x: builtins.concatStringsSep " " (builtins.attrNames x)')"
          for host in ${hosts}; do
            nix build .#build.${arch}.${host} --out-link "${host}"
            attic push selfhosted ./${host}
          done
